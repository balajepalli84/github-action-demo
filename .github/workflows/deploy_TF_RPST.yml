name: Deploy VCN with GitHub OIDC to OCI RPST

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  RPST-terraform:
    runs-on: ubuntu-latest

    env:
      CLIENT_ID: "b3edbc93d0d54c6e85c2c6648ec12c80"
      CLIENT_SECRET: "idcscs-836c279c-2126-4a6b-b6dd-d506d5871747"
      DOMAIN_BASE_URL: "https://idcs-2e5549d1bc154fef937243cd31fcf1af.identity.oraclecloud.com:443"
      OCI_TENANCY: ${{ vars.OCI_TENANCY }}
      OCI_REGION: ${{ vars.OCI_REGION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate RSA Key Pair
        run: |
          mkdir -p .oci
          openssl genrsa -out .oci/temp_private.pem 2048
          openssl rsa -in .oci/temp_private.pem -pubout -out .oci/temp_public.pem
          chmod 600 .oci/temp_private.pem .oci/temp_public.pem

      - name: Convert Private Key to Single Line (No Headers)
        id: privkey
        run: |
          awk '/BEGIN PRIVATE KEY/ {skip=1; next} /END PRIVATE KEY/ {skip=0; next} skip {gsub(/\r/, ""); printf "%s", $0;}' .oci/temp_private.pem > .oci/private_key.one_line.pem

      - name: Convert Public Key (No Headers)
        id: pubkey
        run: |
          awk '/BEGIN PUBLIC KEY/ {skip=1; next} /END PUBLIC KEY/ {skip=0; next} skip {gsub(/\r/, ""); printf "%s", $0;}' .oci/temp_public.pem > .oci/public_key.one_line.pem
          PUBKEY=$(cat .oci/public_key.one_line.pem)
          echo "pubkey=$PUBKEY" >> $GITHUB_OUTPUT

      - name: Fetch GitHub OIDC Token
        id: jwt
        run: |
          curl -sSL -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${CLIENT_ID}" > id-token.json

          JWT=$(jq -r '.value' id-token.json)
          echo "$JWT" > .oci/id-token.jwt
          echo "jwt=$JWT" >> $GITHUB_OUTPUT

      - name: Exchange JWT for OCI RPST
        id: RPST
        continue-on-error: true
        run: |
          AUTH_HEADER=$(printf "%s" "${CLIENT_ID}:${CLIENT_SECRET}" | base64 | tr -d '\n')
          SUBJECT_TOKEN=$(tr -d '\n' < .oci/id-token.jwt)
          PUBKEY=$(tr -d '\n' < .oci/public_key.one_line.pem)

          RESPONSE=$(curl -sSL \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --header "Authorization: Basic $AUTH_HEADER" \
            --data-urlencode "grant_type=urn:ietf:params:oauth:grant-type:token-exchange" \
            --data-urlencode "requested_token_type=urn:oci:token-type:oci-RPST" \
            --data-urlencode "subject_token=$SUBJECT_TOKEN" \
            --data-urlencode "subject_token_type=jwt" \
            --data-urlencode "public_key=$PUBKEY" \
            "${DOMAIN_BASE_URL}/oauth2/v1/token")

          echo "$RESPONSE" > .oci/RPST-response.json
          jq -r '.token' .oci/RPST-response.json | tr -d '\n' > .oci/RPST.token

          if [ -s .oci/RPST.token ]; then
            echo "RPST token was successfully extracted"
            echo "success=true" >> $GITHUB_ENV
          else
            echo "â€¼ï¸ Failed to extract RPST token"
            cat .oci/RPST-response.json
            echo "success=false" >> $GITHUB_ENV
          fi

          {
            echo "==== GitHub OIDC Token ===="
            cat .oci/id-token.jwt | fold -w 80
            echo ""
            echo "==== RPST Response ===="
            cat .oci/RPST-response.json | fold -w 80
            echo ""
            echo "==== Extracted RPST Token (if present) ===="
            [ -s .oci/RPST.token ] && cat .oci/RPST.token | fold -w 80 || echo "(not available)"
          } > .oci/token-debug.log

      - name: Configure OCI Config for Terraform
        if: env.success == 'true'
        run: |
          chmod 600 .oci/temp_private.pem .oci/RPST.token
      
          FINGERPRINT=$(openssl rsa -pubout -outform DER -in .oci/temp_private.pem 2>/dev/null | openssl md5 -c | awk '{print $2}')
          WORK_DIR=$(pwd)
      
          CONFIG_PATH="${WORK_DIR}/.oci/RPST_config"
          echo "[DEFAULT]" > $CONFIG_PATH
          echo "region=${OCI_REGION}" >> $CONFIG_PATH
          echo "tenancy=${OCI_TENANCY}" >> $CONFIG_PATH
          echo "fingerprint=${FINGERPRINT}" >> $CONFIG_PATH
          echo "key_file=${WORK_DIR}/.oci/temp_private.pem" >> $CONFIG_PATH
          echo "security_token_file=${WORK_DIR}/.oci/RPST.token" >> $CONFIG_PATH
      
          echo "OCI_CONFIG_FILE=${CONFIG_PATH}" >> $GITHUB_ENV
          
          echo "âœ… Created OCI config at: $CONFIG_PATH"
          echo "ðŸ“„ Config contents:"
          cat $CONFIG_PATH

      - name: Upload Debug Files (Always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oci-RPST-debug
          path: |
            .oci/token-debug.log
            .oci/RPST-response.json
            .oci/id-token.jwt
            .oci/public_key.one_line.pem
            .oci/temp_private.pem
            .oci/RPST.token
            .oci/RPST_config

      - name: Set up Terraform
        if: env.success == 'true'
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (VCN)
        if: env.success == 'true'
        run: terraform init
        working-directory: terraform/vcn
        env:
          OCI_CONFIG_FILE: ${{ env.OCI_CONFIG_FILE }}
      
      - name: Terraform Plan (VCN)
        if: env.success == 'true'
        run: terraform plan
        working-directory: terraform/vcn
        env:
          OCI_CONFIG_FILE: ${{ env.OCI_CONFIG_FILE }}
      
      - name: Terraform Apply (VCN)
        if: env.success == 'true'
        run: terraform apply -auto-approve
        working-directory: terraform/vcn
        env:
          OCI_CONFIG_FILE: ${{ env.OCI_CONFIG_FILE }}
