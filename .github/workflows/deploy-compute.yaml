name: Deploy Compute with GitHub OIDC to OCI UPST

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Prepare UPST Token
        run: |
          chmod +x ./scripts/prepare_upst.sh
          ./scripts/prepare_upst.sh
        env:
          CLIENT_ID: "8aa264f421d646e98699b716b2e9b72e"
          CLIENT_SECRET: "idcscs-59183ab6-657c-4a24-ad24-ffae6c8bc061"
          DOMAIN_BASE_URL: "https://idcs-8dd307747946491cbfe1b7a3f063db0d.identity.oraclecloud.com"
          OCI_TENANCY: ${{ vars.OCI_TENANCY }}
          OCI_REGION: ${{ vars.OCI_REGION }}
          ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ env.ACTIONS_ID_TOKEN_REQUEST_TOKEN }}
          ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}

      - name: Start Background Token Refresher
        run: |
          chmod +x ./scripts/refresh_upst_token.sh
          nohup ./scripts/refresh_upst_token.sh > upst_refresh.log 2>&1 &
        env:
          CLIENT_ID: "8aa264f421d646e98699b716b2e9b72e"
          CLIENT_SECRET: "idcscs-59183ab6-657c-4a24-ad24-ffae6c8bc061"
          DOMAIN_BASE_URL: "https://idcs-8dd307747946491cbfe1b7a3f063db0d.identity.oraclecloud.com"

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: terraform/compute

      - name: Terraform Plan
        run: terraform plan
        working-directory: terraform/compute
        env:
          OCI_CLI_PROFILE: upst

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: terraform/compute
        env:
          OCI_CLI_PROFILE: upst
      - name: Upload UPST Token and Config Files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oci-upst-files
          path: |
            .oci/temp_private.pem
            .oci/temp_public.pem
            .oci/id-token.json
            .oci/upst.token
            $HOME/.oci/config
      - name: Debug Token and Config Files
        run: |
          echo "===== .oci/upst.token (length) ====="
          wc -c < .oci/upst.token || true

          echo "===== .oci/id-token.json ====="
          jq '.' .oci/id-token.json || cat .oci/id-token.json

          echo "===== .oci/temp_private.pem (first 5 lines) ====="
          head -n 5 .oci/temp_private.pem || true

          echo "===== ~/.oci/config ====="
          cat $HOME/.oci/config || echo "No config file found"

          echo "===== OCI CLI Profile Used ====="
          echo $OCI_CLI_PROFILE


