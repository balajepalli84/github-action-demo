name: Deploy Compute with GitHub OIDC to OCI UPST

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Prepare UPST Token
        run: |
          chmod +x ./scripts/prepare_upst.sh
          ./scripts/prepare_upst.sh
        env:
          CLIENT_ID: "8aa264f421d646e98699b716b2e9b72e"
          CLIENT_SECRET: "idcscs-59183ab6-657c-4a24-ad24-ffae6c8bc061"
          DOMAIN_BASE_URL: "https://idcs-8dd307747946491cbfe1b7a3f063db0d.identity.oraclecloud.com"
          OCI_TENANCY: ${{ vars.OCI_TENANCY }}
          OCI_REGION: ${{ vars.OCI_REGION }}
          ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ env.ACTIONS_ID_TOKEN_REQUEST_TOKEN }}
          ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}
      - name: Start Background Token Refresher
        run: |
          chmod +x ./scripts/refresh_upst_token.sh
          nohup ./scripts/refresh_upst_token.sh > upst_refresh.log 2>&1 &
        env:
          CLIENT_ID: ${{ env.CLIENT_ID }}
          CLIENT_SECRET: ${{ env.CLIENT_SECRET }}
          DOMAIN_BASE_URL: ${{ env.DOMAIN_BASE_URL }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: terraform/compute
        env:
          OCI_CLI_PROFILE: upst

      - name: Terraform Plan
        run: terraform plan
        working-directory: terraform/compute
        env:
          OCI_CLI_PROFILE: upst

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: terraform/compute
        env:
          OCI_CLI_PROFILE: upst
      - name: Terraform Loop (simulate long-running process)
        run: |
          for i in {1..5}; do
            echo "Run $i at $(date)"
            echo -n "Current UPST token: "
            head -c 10 ~/.oci/upst.token
            echo ""
            terraform apply -auto-approve || true
            sleep 15
          done
        working-directory: terraform/compute
        env:
          OCI_CLI_PROFILE: upst



